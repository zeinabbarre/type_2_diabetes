# creating the table 
CREATE TABLE tajimas_PJL (
    chromosome INTEGER,
    bin_start INTEGER,
    n_snps INTEGER,
    tajimas_d REAL
);


## populating the new tajimas PJL 
import sqlite3
import pandas as pd

# Connect to SQLite
db_path = "/mnt/c/Users/Hp EliteBook 840 G3/OneDrive/Desktop/type_2_diabetes/instance/db.db"

conn = sqlite3.connect(db_path)
cursor = conn.cursor()

# Load Tajima's D file
tajima_df = pd.read_csv("/mnt/c/Users/Hp EliteBook 840 G3/OneDrive/Desktop/type_2_diabetes/csv_files/filtered_merged_tajimasD_all_chromosomes.csv")

# Ensure column names match the `tajimas_PJL` table
tajima_df.columns = ["chromosome", "bin_start", "n_snps", "tajimas_d"]  # Adjust if needed

# Option 1: Drop rows where 'tajimas_d' is NaN
# tajima_df = tajima_df.dropna(subset=["tajimas_d"])

# Option 2: Fill NaN values with 0 (or another default value)
tajima_df["tajimas_d"].fillna(0, inplace=True)  # Replace NaN with 0

# Save to SQLite
tajima_df.to_sql("tajimas_PJL", conn, if_exists="append", index=False)  # ‚úÖ Append to existing table

print("‚úÖ Tajima's D data imported successfully into tajimas_PJL!")
conn.close()




#####  WEB APPLICATION.PY CODE AFTER ######

from flask import Flask, render_template, request, redirect, url_for, flash, jsonify, send_file
import sqlite3
import re
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # ‚úÖ Force non-GUI backend before importing pyplot
import matplotlib.pyplot as plt
import io
import os
import numpy as np 

app = Flask(__name__, static_folder='static', static_url_path='/static')
app.secret_key = 'supersecretkey'  # Needed for flashed messages
DB_PATH = "/mnt/c/Users/Hp EliteBook 840 G3/OneDrive/Desktop/type_2_diabetes/instance/db.db"

# ‚úÖ Function to Establish Database Connection
def get_db_connection():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row  # Enables dictionary-like access
    return conn

@app.route('/')
def index():
    """Renders the homepage."""
    return render_template('index.html')

# ‚úÖ SEARCH FUNCTIONALITY (SNP, Gene, Genomic Coordinates)
@app.route('/search_snp', methods=['POST'])
def search_snp():
    """Handles search for SNPs, genes, or genomic coordinates."""
    query = request.form['search_query'].strip()
    conn = get_db_connection()

    # üîπ Search by SNP Name
    snp = conn.execute("""
        SELECT snp_name, chr_id, chr_pos
        FROM SNPs
        WHERE LOWER(snp_name) = LOWER(?)
    """, (query,)).fetchone()

    if snp:
        conn.close()
        return redirect(url_for('snp_details', snp_name=snp['snp_name']))

    # üîπ Search by Gene Name
    gene = conn.execute("SELECT * FROM Genes WHERE LOWER(gene_name) = LOWER(?)", (query,)).fetchone()
    
    if gene:
        snps = conn.execute("""
            SELECT s.snp_id, s.snp_name, s.chr_id, s.chr_pos
            FROM SNPs s
            JOIN SNP_Gene sg ON s.snp_id = sg.snp_id
            WHERE sg.gene_id = ?
        """, (gene['gene_id'],)).fetchall()

        #Fetch distinct populations from Populations table
        populations = conn.execute("""
        SELECT DISTINCT region FROM Populations
    """).fetchall()
        populations = [pop['region'] for pop in populations]

        conn.close()
        return render_template('filtered_snps.html', snps=snps, populations=populations, query=query)
    

    # üîπ Search by Genomic Coordinates
    match = re.match(r"^(\d+):(\d+)-(\d+)$", query)
    if match:
        chromosome, start_pos, end_pos = match.groups()
        start_pos, end_pos = int(start_pos), int(end_pos)

        # ‚úÖ Fetch SNPs in the given genomic region
        snps = conn.execute("""
            SELECT snp_id, snp_name, chr_id, chr_pos
            FROM SNPs 
            WHERE chr_id = ? AND chr_pos BETWEEN ? AND ?
        """, (chromosome, start_pos, end_pos)).fetchall()

        # ‚úÖ Fetch all unique population regions from the `Populations` table
        populations = conn.execute("""
            SELECT DISTINCT region FROM Populations
        """).fetchall()
        populations = [pop["region"] for pop in populations]

        conn.close()

        if snps:
            return render_template('filtered_snps.html', snps=snps, populations=populations, query=query)

        flash("No SNPs found in the specified region.", "error")
        return redirect(url_for('index'))

    # üîπ No results found
    flash("No results found.", "error")
    conn.close()
    return redirect(url_for('index'))

# ‚úÖ SNP DETAILS PAGE
@app.route('/snp/<snp_name>')
def snp_details(snp_name):
    """Displays detailed SNP information along with mapped genes and populations (without Population column and duplicates)."""
    conn = get_db_connection()

    # üîπ Fetch SNP details
    snp = conn.execute("""
        SELECT * FROM SNPs WHERE snp_name = ?
    """, (snp_name,)).fetchone()

    # üîπ If SNP is not in the SNPs table, check if it exists in Populations
    if not snp:
        pop_snp = conn.execute("""
            SELECT DISTINCT snp_id FROM Populations WHERE snp_id = (
                SELECT snp_id FROM SNPs WHERE snp_name = ?
            )
        """, (snp_name,)).fetchone()

        if pop_snp:
            snp = {"snp_name": snp_name, "chr_id": "Unknown", "chr_pos": "Unknown", "snp_id": pop_snp["snp_id"]}
        else:
            conn.close()
            flash(f"SNP '{snp_name}' not found.", "error")
            return redirect(url_for('index'))

    # üîπ Get mapped genes (only if SNP is in `SNPs`)
    mapped_genes = []
    if isinstance(snp, sqlite3.Row) and "snp_id" in snp.keys():
        mapped_genes = conn.execute("""
            SELECT g.gene_name 
            FROM SNP_Gene sg
            INNER JOIN Genes g ON sg.gene_id = g.gene_id
            WHERE sg.snp_id = ?
        """, (snp["snp_id"],)).fetchall()

    # üîπ Get population data (without Population column) and remove duplicates
    populations = conn.execute("""
        SELECT DISTINCT p_value, sample_size 
        FROM Populations WHERE snp_id = ?
    """, (snp["snp_id"],)).fetchall()

    conn.close()
    return render_template('snp_details.html', snp=snp, mapped_genes=mapped_genes, populations=populations)


@app.route('/filter_by_population', methods=['POST'])
def filter_by_population():
    """Filters SNPs by population and displays results. Computes summary stats for South Asian population."""
    population = request.form.get('population')
    snp_ids = request.form.get('snp_ids')

    if not population or not snp_ids:
        flash("Invalid selection. Please choose a population.", "error")
        return redirect(url_for('index'))

    conn = get_db_connection()
    snp_ids_list = snp_ids.split(',')

    print("üöÄ Processing Population:", population)
    print("üìå SNP IDs Received:", snp_ids_list)

    # ‚úÖ Query SNPs for the selected population
    placeholders = ','.join(['?'] * len(snp_ids_list))
    query = f"""
        SELECT s.snp_name, s.chr_id, s.chr_pos, p.p_value, p.sample_size, s.snp_id
        FROM SNPs s
        JOIN Populations p ON s.snp_id = p.snp_id
        WHERE p.region = ? AND s.snp_id IN ({placeholders})
    """

    params = [population] + snp_ids_list
    snps = conn.execute(query, params).fetchall()

    print(f"üìä Retrieved {len(snps)} SNPs")  # Debugging print

    # ‚úÖ Fetch mapped genes for each SNP
    mapped_genes = {}
    for snp in snps:
        genes = conn.execute("""
            SELECT g.gene_name 
            FROM SNP_Gene sg
            JOIN Genes g ON sg.gene_id = g.gene_id
            WHERE sg.snp_id = ?
        """, (snp["snp_id"],)).fetchall()
        mapped_genes[snp["snp_name"]] = [gene["gene_name"] for gene in genes]

    # ‚úÖ Count unique SNP names
    unique_snp_names = set(snp["snp_name"] for snp in snps)

    summary_stats = None
    tajima_plot_url = None
    download_url = None

    # ‚úÖ Always Compute Summary Stats & Plot for South Asian Population
    if population.lower() == "south asian" and snps:
        stats_query = """SELECT tajimas_d FROM tajimas_BEB"""
        result = conn.execute(stats_query).fetchall()

        # ‚úÖ Extract values and remove None
        tajima_values = [row["tajimas_d"] for row in result if row["tajimas_d"] is not None]

        if tajima_values:
            summary_stats = {
                "min_tajimas_d": min(tajima_values),
                "max_tajimas_d": max(tajima_values),
                "avg_tajimas_d": np.mean(tajima_values),
                "median_tajimas_d": np.median(tajima_values),
                "std_tajimas_d": np.std(tajima_values)
            }

            print("‚úÖ Summary Statistics Computed:", summary_stats)  # Debugging print

            # ‚úÖ Save summary statistics as a text file
            static_dir = os.path.join(os.getcwd(), "static")
            os.makedirs(static_dir, exist_ok=True)

            summary_file_path = os.path.join(static_dir, "summary_statistics.txt")
            with open(summary_file_path, "w") as f:
                f.write("Tajima's D Summary Statistics\n")
                for key, value in summary_stats.items():
                    f.write(f"{key.replace('_', ' ').title()}: {value:.3f}\n")

            download_url = url_for("download_summary")

            # ‚úÖ Generate Tajima‚Äôs D plot only for South Asian SNPs
            if snps:
                chromosome = snps[0]["chr_id"]
                start_pos = min([snp["chr_pos"] for snp in snps])
                end_pos = max([snp["chr_pos"] for snp in snps])

                tajima_plot_url = url_for('tajimas_image', chromosome=chromosome, start=start_pos, end=end_pos)

    conn.close()

    return render_template(
        'population_snps.html',
        snps=snps,
        region=population,
        unique_snp_count=len(unique_snp_names),
        mapped_genes=mapped_genes,
        summary_stats=summary_stats,  # ‚úÖ Always passed
        tajima_plot_url=tajima_plot_url,  # ‚úÖ Always passed
        download_url=download_url  # ‚úÖ Always passed
    )


# ‚úÖ Route for Downloading Summary Statistics
@app.route("/download_summary")
def download_summary():
    """Allows users to download summary statistics as a text file."""
    static_dir = os.path.join(os.getcwd(), "static")  # Ensure we're using the right directory
    summary_file_path = os.path.join(static_dir, "summary_statistics.txt")

    # ‚úÖ Check if the file actually exists before sending it
    if not os.path.exists(summary_file_path):
        print(f"‚ùå ERROR: File not found at {summary_file_path}")
        return "Error: Summary statistics file not found", 404

    print(f"‚úÖ Sending file: {summary_file_path}")
    return send_file(summary_file_path, as_attachment=True, download_name="summary_statistics.txt")

# Function to fetch Tajima's D values
def get_tajimas(chromosome, start_pos, end_pos, table_name):
    """Fetch Tajima's D values for a specific region from the given SQL table."""
    conn = sqlite3.connect(DB_PATH)  # Use the correct database path
    query = f'''
    SELECT bin_start, tajimas_d
    FROM {table_name}
    WHERE chromosome = ?
    AND bin_start BETWEEN ? AND ?
    ORDER BY bin_start;
    '''
    
    try:
        df = pd.read_sql_query(query, conn, params=(chromosome, start_pos, end_pos))
    except Exception as e:
        print(f"‚ùå SQL Error while querying {table_name}: {e}")
        df = pd.DataFrame()  # Return an empty DataFrame if there's an error
    finally:
        conn.close()  # Ensure the connection is properly closed

    return df  # ‚úÖ Now it actually returns the DataFrame


@app.route('/tajimas_image')
def tajimas_image():
    """Generates and serves separate Tajima's D plot images for both Punjabi and Bengali populations."""
    chrom = request.args.get('chromosome', type=int)
    start_pos = request.args.get('start', type=int)
    end_pos = request.args.get('end', type=int)

    if not chrom or not start_pos or not end_pos:
        return jsonify({"error": "Missing parameters"}), 400

    # Generate the separate Tajima‚Äôs D plot
    img = plot_tajimas_separate(chrom, start_pos, end_pos)

    # Serve the generated image
    return send_file(img, mimetype='image/png')



# Function to Generate the Tajima's D Plot (Helper Function)
def plot_tajimas_separate(chromosome, start_pos, end_pos):
    """Generate and return separate Tajima's D plots for Punjabi (PJL) and Bengali (BEB) populations."""

    # Fetch data for both populations
    df_pjl = get_tajimas(chromosome, start_pos, end_pos, "tajimas_pjl")
    df_beb = get_tajimas(chromosome, start_pos, end_pos, "tajimas_BEB")

    # Create the figure and axes
    fig, axes = plt.subplots(2, 1, figsize=(10, 10))  # Create two subplots vertically

    # Plot for Punjabi (PJL)
    if not df_pjl.empty:
        axes[0].plot(df_pjl["bin_start"], df_pjl["tajimas_d"], marker="o", linestyle="-", color="blue", label="Punjabi (Lahore)")
        axes[0].axhline(y=0, color="black", linestyle="--", label="Neutral Selection")
        axes[0].set_title(f"Tajima's D for Punjabi (PJL) - Chromosome {chromosome} ({start_pos}-{end_pos})")
        axes[0].set_xlabel("Genomic Position (bp)")
        axes[0].set_ylabel("Tajima's D")
        axes[0].legend()

    # Plot for Bengali (BEB)
    if not df_beb.empty:
        axes[1].plot(df_beb["bin_start"], df_beb["tajimas_d"], marker="s", linestyle="--", color="red", label="Bengali (Bangladesh)")
        axes[1].axhline(y=0, color="black", linestyle="--", label="Neutral Selection")
        axes[1].set_title(f"Tajima's D for Bengali (BEB) - Chromosome {chromosome} ({start_pos}-{end_pos})")
        axes[1].set_xlabel("Genomic Position (bp)")
        axes[1].set_ylabel("Tajima's D")
        axes[1].legend()

    # Save the image to a BytesIO object and return it
    img = io.BytesIO()
    plt.tight_layout()  # Adjust layout to prevent overlap
    plt.savefig(img, format='png')
    plt.close()  # Close the plot to avoid display issues
    img.seek(0)

    return img


@app.route('/gene/<gene_name>')
def gene_ontology(gene_name):
    """Displays ontology terms for a given gene using the Ontology table."""
    conn = get_db_connection()

    # Get the gene details, including gene_id
    gene = conn.execute("SELECT * FROM Genes WHERE gene_name = ?", (gene_name,)).fetchone()
    if not gene:
        conn.close()
        flash(f"Gene '{gene_name}' not found.", "error")
        return redirect(url_for('index'))

    # Fetch ontology data from the Ontology table
    ontology = conn.execute("""
        SELECT gene_stable_id, description, gene_type, 
               molecular_function, biological_process, cellular_component
        FROM Ontology
        WHERE gene_id = ?
    """, (gene['gene_id'],)).fetchone()

    conn.close()

    # If no ontology data is found, handle it gracefully
    if not ontology:
        flash(f"No ontology data found for gene '{gene_name}'.", "warning")
        return render_template('gene_ontology.html', gene_name=gene_name, ontology_data={}, gene_info={})

    # Organize ontology data
    ontology_data = {
        "Molecular Function": ontology['molecular_function'].split('; ') if ontology['molecular_function'] else [],
        "Biological Process": ontology['biological_process'].split('; ') if ontology['biological_process'] else [],
        "Cellular Component": ontology['cellular_component'].split('; ') if ontology['cellular_component'] else []
    }

    # Additional gene information
    gene_info = {
        "Stable ID": ontology['gene_stable_id'],
        "Description": ontology['description'],
        "Gene Type": ontology['gene_type']
    }

    return render_template('gene_ontology.html', gene_name=gene_name, ontology_data=ontology_data, gene_info=gene_info)


if __name__ == '__main__':
    app.run(debug=True)


###### CHNAGES MADE TO THE TAJIMA_PLOT.HTML #####


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tajima's D Plot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .container {
            max-width: 80%;
            margin: auto;
            text-align: center;
        }

        img {
            max-width: 100%;
            height: auto;
            border: 2px solid #ccc;
            border-radius: 10px;
            margin-top: 20px;
        }

        .back-button {
            display: inline-block;
            margin-top: 15px;
            padding: 12px;
            font-size: 16px;
            border-radius: 5px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .back-button:hover {
            background-color: #0056b3;
        }

        .plot-container {
            display: flex;
            justify-content: space-around;
            margin-top: 40px;
        }

        .plot-container img {
            width: 48%;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Tajima‚Äôs D Plot for Chromosome {{ chromosome }}: {{ start_pos }} - {{ end_pos }}</h1>

        <div class="plot-container">
            <!-- Punjabi (Lahore) Tajima's D Plot -->
            <div>
                <h3>Punjabi (Lahore) Tajima's D Plot</h3>
                <img src="{{ url_for('tajimas_image', chromosome=chromosome, start=start_pos, end=end_pos, table_name='tajimas_pjl') }}" alt="Punjabi Tajima's D Plot">
            </div>

            <!-- Bengali (Bangladesh) Tajima's D Plot -->
            <div>
                <h3>Bengali (Bangladesh) Tajima's D Plot</h3>
                <img src="{{ url_for('tajimas_image', chromosome=chromosome, start=start_pos, end=end_pos, table_name='tajimas_beb') }}" alt="Bengali Tajima's D Plot">
            </div>
        </div>

        <br>
        <a href="{{ url_for('index') }}" class="back-button">Back to Search</a>
    </div>

</body>
</html>

### populations.html ####


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filtered SNPs by Population</title>
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

<style>
.container {
    max-width: 90%;
    margin: auto;
    text-align: center;
    padding-bottom: 40px;
}

.table-container {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #ccc;
    margin-top: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
    table-layout: fixed;
}

th {
    background-color: #007BFF;
    color: white;
    position: sticky;
    top: 0;
    z-index: 2;
    padding: 12px;
}

th, td {
    padding: 12px;
    border: 1px solid #ddd;
    word-wrap: break-word;
    white-space: normal;
}

tr:nth-child(even) {
    background-color: #f2f2f2;
}

.details-link {
    color: #007BFF;
    text-decoration: none;
    font-weight: bold;
}

.details-link:hover {
    text-decoration: underline;
}

.back-button {
    display: inline-block;
    margin-top: 15px;
    padding: 12px;
    font-size: 16px;
    border-radius: 5px;
    background-color: #007BFF;
    color: white;
    border: none;
    cursor: pointer;
    text-decoration: none;
}

.back-button:hover {
    background-color: #0056b3;
}

/* ‚úÖ Style for Tajima's D plot */
.tajima-plot {
    margin-top: 30px;
    text-align: center;
}

.tajima-plot img {
    width: 80%;
    border: 1px solid #ccc;
    padding: 10px;
    background: white;
}

/* ‚úÖ Download Button */
.download-button {
    display: inline-block;
    padding: 10px 15px;
    margin-top: 15px;
    font-size: 16px;
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    text-decoration: none;
    border-radius: 5px;
}

.download-button:hover {
    background-color: #218838;
}
</style>
</head>
<body>

<div class="container">
    <h1>SNPs for Population: {{ region }}</h1>

    <!-- ‚úÖ Prevent Population Dropdown from Showing Again -->
    {% if not region %}
    <div class="filter-container">
        <form id="populationForm" method="POST" action="{{ url_for('filter_by_population') }}">
            <label for="populationSelect"><strong>Select a Population:</strong></label>
            <select name="population" id="populationSelect">
                <option value="" disabled selected>Choose a population</option>
                <option value="South Asian">South Asian</option>
                <option value="European">European</option>
                <option value="African">African</option>
                <option value="East Asian">East Asian</option>
            </select>
            <input type="hidden" name="snp_ids" id="snpIds" value="{{ ','.join(snp_ids) }}">
            <button type="submit">Filter</button>
        </form>
    </div>
    {% endif %}

    <!-- ‚úÖ Tajima's D Summary Statistics (Only for South Asian) -->
    {% if region and region.lower() == "south asian" and summary_stats %}
        <h2>Tajima's D Summary Statistics</h2>
        <table>
            <tr><td><strong>Min Tajima‚Äôs D:</strong></td><td>{{ summary_stats["min_tajimas_d"] }}</td></tr>
            <tr><td><strong>Max Tajima‚Äôs D:</strong></td><td>{{ summary_stats["max_tajimas_d"] }}</td></tr>
            <tr><td><strong>Mean Tajima‚Äôs D:</strong></td><td>{{ summary_stats["avg_tajimas_d"] }}</td></tr>
            <tr><td><strong>Median Tajima‚Äôs D:</strong></td><td>{{ summary_stats["median_tajimas_d"] }}</td></tr>
            <tr><td><strong>Standard Deviation:</strong></td><td>{{ summary_stats["std_tajimas_d"] }}</td></tr>
        </table>

        {% if download_url %}
            <br>
            <a href="{{ download_url }}" class="download-button">Download Summary Statistics</a>
        {% endif %}
    {% endif %}

    <!-- ‚úÖ SNP Table -->
    {% if snps and snps|length > 0 %}
        <p><strong>Showing {{ snps|length }} SNPs</strong> in <strong>{{ region }}</strong>.</p>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>SNP Name</th>
                        <th>Chromosome</th>
                        <th>Position</th>
                        <th>P-Value</th>
                        <th>Sample Size</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for snp in snps %}
                        <tr>
                            <td>{{ snp.snp_name }}</td>
                            <td>{{ snp.chr_id }}</td>
                            <td>{{ snp.chr_pos }}</td>
                            <td>{{ snp.p_value if snp.p_value else 'N/A' }}</td>
                            <td>{{ snp.sample_size if snp.sample_size else 'N/A' }}</td>
                            <td>
                                <a href="{{ url_for('snp_details', snp_name=snp.snp_name) }}" class="details-link">
                                    View Details
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No SNPs found for this population.</p>
    {% endif %}

    <!-- ‚úÖ Fix: Show Tajima's D Plot only for South Asian population -->
    {% if region and region.lower() == "south asian" and tajima_plot_url %}
        <div class="tajima-plot">
            <h2>Tajima's D Plot</h2>
            <img src="{{ tajima_plot_url }}" alt="Tajima's D Plot">
        </div>
    {% endif %}

    <br>
    <a href="{{ url_for('index') }}" class="back-button">Back to Search</a>
</div>

</body>
</html>
